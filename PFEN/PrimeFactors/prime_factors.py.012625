import gzip
import re
import mysql.connector
import os

# Define the file name
prime_factor_file = __file__.replace('.py', '.txt.gz')

# Database connection setup
db_config = {
    'host': os.getenv('DB_HOST', 'localhost'),
    'user': os.getenv('DB_USER', 'PFEN_Modify'),
    'password': os.getenv('DB_PASSWORD', ''),
    'database': os.getenv('DB_NAME', 'PFEN')
}

def insert_prime_to_db(prime, prime_index):
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        # Insert prime into the Primes table
        query = "INSERT INTO Primes (prime) VALUES (%s,%s)"
        cursor.execute(query, (prime,prime_sequence))
        conn.commit()
        
        # Retrieve the last inserted ID
        prime_id = cursor.lastrowid
        print(f"Inserted prime {prime} as the {prime_index}-th prime into the database with ID {prime_id}.")
        return prime_id
    except mysql.connector.Error as err:
        print(f"Error: {err}")
        return None
    finally:
        if conn:
            conn.close()

def insert_number_to_db(number):
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        # Insert number into the Numbers table
        query = "INSERT INTO Numbers (number_value) VALUES (%s)"
        cursor.execute(query, (number,))
        conn.commit()
        
        # Retrieve the last inserted ID
        number_id = cursor.lastrowid
        print(f"Inserted number {number} into the database with ID {number_id}.")
        return number_id
    except mysql.connector.Error as err:
        print(f"Error: {err}")
        return None
    finally:
        if conn:
            conn.close()

def insert_prime_factors_to_db(number, factors):
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        # Insert into PrimeFactors table
        query = "INSERT INTO PrimeFactors (number_id, prime_id, exponent) VALUES (%s, %s, %s)"
        for prime, exponent in factors.items():
            cursor.execute(query, (number, prime, exponent))
        conn.commit()
        
        print(f"Inserted prime factors for number {number} into the database.")
    except mysql.connector.Error as err:
        print(f"Error: {err}")
    finally:
        if conn:
            conn.close()

try:
    with gzip.open(prime_factor_file, 'rt') as z:
        for line in z:
            if '=' not in line:
                continue

            print(line.strip())
            line = line.strip()

            # Extract number and RHS
            match = re.match(r'(^\d+)=(.*)', line)
            if match:
                number, RHS = match.groups()
                number = int(number)

                # Insert the number into the Numbers table
                number_id = insert_number_to_db(number)

                # Check if the number is a prime
                prime_match = re.search(r'\((\d+)\)', line)
                if prime_match:
                    prime = number
                    prime_sequence = int(prime_match.group(1))
                    print(f" {number} is the {prime_index}-th prime.")

                    # Insert the prime into the database
                    prime_id = insert_prime_to_db(prime, prime_sequence)

                # Check for prime factor sequence
                if ';' in RHS:
                    prime_factor_sequence = int(RHS.split(';')[-1])
                    print(f" {number} is a prime factor sequence: {prime_factor_sequence}")
                    RHS = RHS.split(';')[0]

                # Parse factorization if it's a product of primes
                if re.match(r'^[0-9x^]+$', RHS):
                    def parse_factorization(factorization_string):
                        factors = factorization_string.split('x')
                        factor_exponents = {}
                        for prime_factor in factors:
                            factor, _, exponent = prime_factor.partition('^')
                            factor = int(factor)
                            exponent = int(exponent) if exponent else 1
                            factor_exponents[factor] = exponent
                        print(" ", ", ".join(factors))
                        return factor_exponents

                    factors = parse_factorization(RHS)

                    # Insert prime factors into the database
                    insert_prime_factors_to_db(number_id, factors)

except FileNotFoundError:
    print(f"Cannot read from '{prime_factor_file}': File not found.")
except OSError as e:
    print(f"Error reading gzip file: {e}")

