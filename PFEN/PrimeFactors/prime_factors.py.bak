import gzip
import re
import mysql.connector

# Define the file name
prime_factor_file = __file__.replace('.py.bak', '.txt.gz')

# Database connection setup
db_config = {
    'host': 'localhost',
    'user': 'your_username',
    'password': 'your_password',
    'database': 'your_database'
}

def insert_prime_to_db(prime, prime_index):
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        # Insert prime into the Primes table
        query = "INSERT INTO Primes (prime_id, prime_number) VALUES (%s, %s)"
        cursor.execute(query, (prime_index, prime))
        conn.commit()
        
        print(f"Inserted prime {prime} as the {prime_index}-th prime into the database.")
    except mysql.connector.Error as err:
        print(f"Error: {err}")
    finally:
        if conn:
            conn.close()

def insert_number_to_db(number):
    try:
        conn = mysql.connector.connect(**db_config)
        cursor = conn.cursor()
        
        # Insert number into the Numbers table
        query = "INSERT INTO Numbers (number_id, number_value) VALUES (%s, %s)"
        cursor.execute(query, (number, number))
        conn.commit()
        
        print(f"Inserted number {number} into the database.")
    except mysql.connector.Error as err:
        print(f"Error: {err}")
    finally:
        if conn:
            conn.close()

try:
    with gzip.open(prime_factor_file, 'rt') as z:
        for line in z:
            if '=' not in line:
                continue

            print(line.strip())
            line = line.strip()

            # Extract number and RHS
            match = re.match(r'(^\d+)=(.*)', line)
            if match:
                number, RHS = match.groups()
                number = int(number)

                # Insert the number into the Numbers table
                insert_number_to_db(number)

                # Check if the number is a prime
                prime_match = re.search(r'\((\d+)\)', line)
                if prime_match:
                    prime = number
                    prime_index = int(prime_match.group(1))
                    print(f" {number} is the {prime_index}-th prime.")

                    # Insert the prime into the database
                    insert_prime_to_db(prime, prime_index)

                # Check for prime factor sequence
                if ';' in RHS:
                    prime_factor_sequence = int(RHS.split(';')[-1])
                    print(f" {number} is a prime factor sequence: {prime_factor_sequence}")
                    RHS = RHS.split(';')[0]

                # Parse factorization if it's a product of primes
                if re.match(r'^[0-9x^]+$', RHS):
                    def parse_factorization(factorization_string):
                        factors = factorization_string.split('x')
                        factor_exponents = {}
                        for prime_factor in factors:
                            factor, _, exponent = prime_factor.partition('^')
                            factor = int(factor)
                            exponent = int(exponent) if exponent else 1
                            factor_exponents[factor] = exponent
                        print(" ", ", ".join(factors))
                        return factor_exponents

                    parse_factorization(RHS)

except FileNotFoundError:
    print(f"Cannot read from '{prime_factor_file}': File not found.")
except OSError as e:
    print(f"Error reading gzip file: {e}")

